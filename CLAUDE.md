# CLAUDE.md - Project Guide for AI Assistants

## Project Overview

**TaskFlow** is an email-integrated task management system for a manufacturing business. It automatically creates tasks from incoming emails and provides a Kanban board interface for managing workflow.

## Tech Stack

### Backend (Python/Flask)
- **Framework**: Flask 3.0 with Flask-CORS
- **Database**: SQLite with SQLAlchemy ORM
- **Background Jobs**: APScheduler for email scanning
- **Email**: imaplib for IMAP integration
- **Notifications**: python-telegram-bot for Telegram alerts
- **Location**: `/backend/`

### Frontend (React)
- **Framework**: React 18 with React Router
- **State Management**: React hooks (useState, useEffect, useCallback)
- **Styling**: CSS variables for theming, no CSS framework
- **API**: Fetch API (no axios)
- **Location**: `/frontend/`

## File Structure

```
taskflow/
├── backend/
│   ├── app.py              # Main Flask app, all API routes, serves React build
│   ├── models.py           # SQLAlchemy models
│   ├── email_service.py    # IMAP scanning logic
│   ├── telegram_service.py # Telegram notifications
│   ├── scheduler.py        # APScheduler setup
│   ├── config.py           # Config and trigger words
│   └── requirements.txt
│
├── frontend/
│   ├── build/              # Production build (generated by npm run build)
│   ├── src/
│   │   ├── App.jsx              # Main app component with navigation state
│   │   ├── components/
│   │   │   ├── Header.jsx       # Top bar with search, scan dropdown, bulk actions
│   │   │   ├── Sidebar.jsx      # Left navigation (Dashboard, All Tasks, etc.)
│   │   │   ├── StatsPanel.jsx   # Dashboard stats cards
│   │   │   ├── TaskBoard.jsx    # Kanban board with drag-drop
│   │   │   ├── TaskCard.jsx     # Individual task cards with inline subtasks
│   │   │   ├── TaskList.jsx     # List view of tasks
│   │   │   ├── TaskModal.jsx    # Create/edit task modal with template selection
│   │   │   ├── SubtaskList.jsx  # Subtask management in modal
│   │   │   └── SettingsModal.jsx # Settings with tabs: Email, Triggers, Logs, Templates, Telegram, General
│   │   ├── contexts/
│   │   │   └── ThemeContext.jsx # Dark/Medium/Light theme switching
│   │   ├── hooks/
│   │   │   └── useTasks.js      # Task, stats, templates hooks
│   │   ├── services/
│   │   │   └── api.js           # API client functions
│   │   └── styles/
│   │       ├── variables.css    # CSS custom properties
│   │       └── App.css          # All component styles
│   └── package.json
│
└── CLAUDE.md                # This file
```

## Database Models

### Task
- `id`, `title`, `description`
- `customer_name`, `customer_email`, `company`
- `so_number`, `po_number`, `quote_number` (reference numbers)
- `priority` (high/medium/low)
- `status` (scheduled/in_progress/completed)
- `due_date`, `due_time`
- `source_email_id` (if created from email)
- `subtasks` relationship

### Subtask
- `id`, `task_id`, `title`
- `status` (pending/completed)
- `sort_order`

### Other Tables
- `processed_emails` - Tracks scanned emails to prevent duplicates
- `subtask_templates` - Workflow templates (name + JSON array of steps)
- `settings` - Key-value store for IMAP/Telegram config
- `email_scan_logs` - Logs each email scan result with reason (created, skipped_marketing, skipped_no_trigger, skipped_duplicate)

## Key Concepts

### Sidebar Navigation
The sidebar provides navigation between different views:
- **Dashboard** - Stats panel + task board (default view)
- **All Tasks** - Task board/list without stats panel
- **Email Inbox** - Opens Settings modal on Email Log tab
- **Templates** - Opens Settings modal on Templates tab
- **Settings** (gear icon) - Opens Settings modal on Email tab

### Status vs Display Column
Tasks have a database `status` field (scheduled/in_progress/completed), but the Kanban board shows 6 columns:
- **Overdue** - scheduled tasks past due date
- **Urgent** - scheduled tasks due today with high priority
- **Upcoming** - scheduled tasks due within 2 days
- **In Progress** - tasks with status "in_progress"
- **Scheduled** - tasks with status "scheduled" (not date-triggered)
- **Completed** - tasks with status "completed" (collapsible column)

The `getEffectiveStatus()` function in TaskBoard.jsx determines which column a task appears in.

### Drag and Drop
- Dragging to In Progress/Scheduled/Completed changes the actual status
- Dragging to Overdue/Urgent/Upcoming sets status to "scheduled" (column based on due date)
- Uses native HTML5 drag-drop API

### Subtasks & Templates
- Displayed inline on task cards with checkboxes
- Can be toggled complete/incomplete directly on the card
- Full management (add/delete/bulk add) in the task modal
- Shows progress bar when subtasks exist
- **Templates**: Pre-defined sets of subtasks that can be applied to tasks
- Template selection available when creating new tasks OR in Subtasks tab when editing

### Theming
Three themes controlled by CSS variables:
- **Dark** (default) - Dark blue background
- **Dim** - Medium gray background
- **Light** - White background

Theme preference saved to localStorage.

## API Endpoints

### Tasks
- `GET /api/tasks` - List all (with ?status, ?priority, ?search filters)
- `GET /api/tasks/:id` - Get single task with subtasks
- `POST /api/tasks` - Create task
- `PUT /api/tasks/:id` - Update task
- `DELETE /api/tasks/:id` - Delete task
- `POST /api/tasks/:id/apply-template` - Apply subtask template
- `POST /api/tasks/bulk-delete` - Delete multiple tasks (body: `{task_ids: [1,2,3]}`)
- `POST /api/tasks/delete-all` - Delete ALL tasks and clear processed emails

### Subtasks
- `POST /api/tasks/:id/subtasks` - Add subtask
- `PUT /api/subtasks/:id` - Update subtask (including status toggle)
- `DELETE /api/subtasks/:id` - Delete subtask

### Templates
- `GET /api/templates` - List all templates
- `POST /api/templates` - Create template (body: `{name, steps: [...]}`)
- `DELETE /api/templates/:id` - Delete template

### Email
- `POST /api/email/scan-now` - Trigger email scan (body: `{scan_all, days}`)
  - `scan_all: true` - Scan all emails
  - `days: 7` - Scan emails from past N days
- `GET /api/email/status` - Get IMAP connection status
- `GET /api/email/logs` - Get email scan logs
- `DELETE /api/email/logs` - Clear email scan logs
- `GET /api/email/trigger-words` - Get trigger words configuration
- `PUT /api/email/trigger-words` - Update trigger words configuration

### Settings
- `GET /api/settings` - Get all settings
- `PUT /api/settings` - Update settings
- `POST /api/settings/test-imap` - Test IMAP connection
- `POST /api/settings/test-telegram` - Test Telegram bot

### Stats
- `GET /api/stats` - Dashboard statistics

### Health
- `GET /api/health` - Health check endpoint

## Running the Project

### Production Mode (Recommended - Low RAM)
```bash
# Build frontend once
cd frontend
npm run build

# Run single server (serves both API and frontend)
cd backend
./venv/Scripts/python.exe app.py
# Open http://localhost:5000
```

### Development Mode (Hot Reload - High RAM)
```bash
# Terminal 1: Backend with debug
cd backend
DEBUG=true ./venv/Scripts/python.exe app.py

# Terminal 2: Frontend dev server
cd frontend
npm start
# Open http://localhost:3000 (proxies API to :5000)
```

## Email Scanning

### Scan Options (Header dropdown)
- **Scan Unread Only** - Default, scans only UNSEEN emails
- **Past 7 Days** - Scans all emails from last 7 days
- **Past 30 Days** - Scans all emails from last 30 days
- **Scan All Emails** - Scans entire inbox (use sparingly)

### Trigger Words
Configured in Settings → Triggers tab (or `config.py` defaults). Emails containing these words create tasks:
- **Quotes**: quote, rfq, pricing, lead time
- **Orders**: po, purchase order, sales order
- **Urgency**: urgent, asap, deadline, action required
- **Design**: cad, drawing, bom, specification
- **Shipping**: ship, tracking, delivery
- **Communication**: meeting, call, follow up, please review

### Marketing Filters
Emails containing these words are skipped (configurable in Settings → Triggers):
- unsubscribe, newsletter, marketing, promotional, etc.

### Email Date Handling
- Task due date is calculated from the EMAIL's sent date (not scan date)
- Due date = email date + default_due_days setting

## Telegram Integration

The Telegram bot sends ONE-WAY notifications (does not respond to messages).

### Setup
1. Create bot with @BotFather on Telegram
2. Copy bot token to Settings → Telegram → Bot Token
3. Get your Chat ID from @userinfobot (NOT your bot)
4. Paste Chat ID in Settings → Telegram → Chat ID
5. Click "Send Test Message" to verify

## Current State

### Working Features
- ✅ Kanban board with 6 columns
- ✅ Drag-drop between columns
- ✅ Collapsible Completed column
- ✅ Task creation/editing/deletion
- ✅ Bulk select and delete tasks
- ✅ Delete all tasks button
- ✅ Inline subtasks on cards with checkbox toggle
- ✅ Subtask management in modal (single + bulk add)
- ✅ Workflow templates (create, apply, delete)
- ✅ Template selection when creating new tasks
- ✅ Three themes (dark/dim/light)
- ✅ Search filtering
- ✅ List view
- ✅ Stats dashboard
- ✅ Functional sidebar navigation
- ✅ IMAP email scanning (unread, 7 days, 30 days, all)
- ✅ Auto-scan every 5 minutes (past 1 day, regardless of read status)
- ✅ Email thread detection (Re:/Fwd: replies grouped, one task per thread)
- ✅ Email date used for due date calculation
- ✅ Telegram notifications
- ✅ Visual feedback on email scan (toast notification)
- ✅ Configurable trigger words (Settings → Triggers)
- ✅ Configurable marketing filters
- ✅ Email scan logs (Settings → Email Log)
- ✅ Production mode (single server, low RAM)

### UI Notes
- Cards show up to 5 subtasks, "+X more" for additional
- Priority indicated by colored left border on cards
- Due dates show "Today"/"Tomorrow" or "Mon 15" format
- Overdue dates shown in red
- Selection mode: checkbox appears on each card for bulk operations

## Common Tasks

### Adding a new task field
1. Add column in `models.py` Task class
2. Add to `to_dict()` method
3. Update `create_task()` and `update_task()` in `app.py`
4. Add form field in `TaskModal.jsx`
5. Display in `TaskCard.jsx` if needed

### Changing Kanban columns
1. Edit `STATUSES` array in `TaskBoard.jsx`
2. Update `getEffectiveStatus()` logic if needed
3. Update CSS for new status colors in `variables.css`

### Adding new API endpoint
1. Add route in `app.py`
2. Add function in `frontend/src/services/api.js`
3. Use in components via the api object

### Creating a new Settings tab
1. Add tab to `tabs` array in `SettingsModal.jsx`
2. Add state variables for the tab's data
3. Add useEffect to fetch data when tab becomes active
4. Add UI content with `{activeTab === 'tabname' && (...)}`

## Deployment

### Production Server
- **URL**: http://143.198.32.152
- **Server**: DigitalOcean Droplet (Ubuntu 22.04, 2GB RAM)
- **Location**: `/opt/taskflow/`
- **Timezone**: America/Toronto (EST)
- **Database**: SQLite at `/opt/taskflow/backend/taskflow.db` (persisted via Docker volume)

### Deploy Updates
After pushing changes to GitHub, SSH into the VPS and run:
```bash
cd /opt/taskflow && git pull && docker compose up -d --build
```

### Initial Setup (already done)
1. Install Docker: `curl -fsSL https://get.docker.com | sh`
2. Clone repo: `git clone https://github.com/johanmap/taskflow-email-tracker.git /opt/taskflow`
3. Create `.env` file in `/opt/taskflow/` with IMAP credentials
4. Start: `cd /opt/taskflow && docker compose up -d --build`

### Environment Variables (.env)
```
IMAP_SERVER=mail.map-inc.ca
IMAP_PORT=993
IMAP_EMAIL=johan@map-inc.ca
IMAP_PASSWORD=<password>
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=
SECRET_KEY=<random-string>
SCAN_INTERVAL_MINUTES=5
DEFAULT_DUE_DAYS=3
```

### Useful Commands (run on VPS)
```bash
# View logs
docker compose logs -f

# Restart containers
docker compose restart

# Stop containers
docker compose down

# Rebuild after code changes
docker compose up -d --build
```
